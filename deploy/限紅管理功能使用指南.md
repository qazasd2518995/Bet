# 限红管理功能使用指南

## 概述

限红管理功能允许总代理为会员设定不同等级的投注限制，取代原来写死的限红配置，提供更灵活的风控管理。

## 功能特点

### 🎯 主要特性
- **6个限红等级**：从新手到VIP等级，适应不同会员需求
- **动态配置**：支援即时调整限红设定，无需重启系统
- **权限控制**：只有总代理可以调整会员限红等级
- **详细记录**：所有限红调整都会记录在交易记录中
- **即时生效**：调整后立即在投注系统中生效

### 📊 限红等级配置

| 等级 | 名称 | 1-10车号 | 两面 | 冠亚军和大小/单双 | 冠亚军和 | 龙虎 |
|------|------|----------|------|------------------|----------|------|
| level1 | 新手限红 | 500/1000 | 1000/1000 | 1000/1000 | 200/400 | 1000/1000 |
| level2 | 一般限红 | 1000/2000 | 2000/2000 | 2000/2000 | 400/800 | 2000/2000 |
| level3 | 标准限红 | 2500/5000 | 5000/5000 | 5000/5000 | 1000/2000 | 5000/5000 |
| level4 | 进阶限红 | 5000/10000 | 10000/10000 | 10000/10000 | 2000/4000 | 10000/10000 |
| level5 | 高级限红 | 10000/20000 | 20000/20000 | 20000/20000 | 4000/8000 | 20000/20000 |
| level6 | VIP限红 | 20000/40000 | 40000/40000 | 40000/40000 | 8000/16000 | 40000/40000 |

*格式：单注最高/单期限额*

## 使用方法

### 📝 会员管理界面操作

1. **进入会员管理**
   - 登入代理管理平台
   - 点击「会员管理」页签

2. **调整会员限红**
   - 在会员列表中找到目标会员
   - 点击该会员的「调整限红」按钮（重设密码按钮旁边）
   - 选择新的限红等级
   - 填写调整原因（可选）
   - 点击「确认调整」

3. **限红配置预览**
   - 选择限红等级后，系统会显示详细的限红配置
   - 包含各种玩法的单注最高和单期限额
   - 调整前可以预览完整的限制规则

### 🎯 投注系统整合

系统会在会员投注时自动进行限红验证：

1. **动态获取**：根据会员用户名获取当前限红等级
2. **智能验证**：根据投注类型选择对应的限红配置
3. **即时检查**：验证单注金额和单期累计限额
4. **自动拒绝**：超过限额的投注会被系统拒绝

## 技术实现

### 🗄️ 资料库设计

```sql
-- 会员表添加限红等级栏位
ALTER TABLE members ADD COLUMN betting_limit_level VARCHAR(20) DEFAULT 'level1';

-- 限红配置表
CREATE TABLE betting_limit_configs (
    id SERIAL PRIMARY KEY,
    level_name VARCHAR(20) UNIQUE NOT NULL,
    level_display_name VARCHAR(50) NOT NULL,
    config JSONB NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 🔧 API 接口

#### 获取限红配置列表
```
GET /api/betting-limit-configs
```

#### 获取会员限红设定
```
GET /api/member-betting-limit/:memberId
GET /api/member-betting-limit-by-username?username=xxx
```

#### 更新会员限红设定
```
POST /api/update-member-betting-limit
{
  "operatorId": 1,
  "memberId": 123,
  "newLimitLevel": "level3",
  "reason": "会员升级"
}
```

### 📊 限红验证流程

```javascript
// 投注时的限红验证
async function validateBetLimits(betType, value, amount, userBets, username) {
  // 1. 根据用户名获取会员限红设定
  const response = await fetch(`/api/member-betting-limit-by-username?username=${username}`);
  
  // 2. 解析限红配置
  const userConfig = response.data.config;
  
  // 3. 根据投注类型选择对应限制
  let limits = userConfig[betType] || userConfig.twoSide;
  
  // 4. 验证单注限额
  if (amount > limits.maxBet) {
    return { valid: false, message: `单注金额超过限制 ${limits.maxBet}元` };
  }
  
  // 5. 验证单期累计限额
  const totalAmount = userBets.reduce((sum, bet) => sum + bet.amount, 0) + amount;
  if (totalAmount > limits.periodLimit) {
    return { valid: false, message: `单期累计金额超过限制 ${limits.periodLimit}元` };
  }
  
  return { valid: true };
}
```

## 权限管理

### 👥 权限分级

- **总代理 (level 0)**：可以调整所有会员的限红等级
- **一般代理 (level 1+)**：只能查看会员限红，无法修改
- **会员**：可以查看自己的限红设定

### 🔒 安全控制

- 所有限红调整操作都会验证操作者权限
- 记录详细的操作日志，包括操作时间、操作者、调整原因
- 支援操作轨迹追踪和审计

## 注意事项

### ⚠️ 重要提醒

1. **权限限制**：只有总代理可以调整会员限红等级
2. **即时生效**：限红调整后立即生效，会影响会员的下次投注
3. **历史投注**：已经下注的投注不会受到限红调整影响
4. **预设等级**：新创建的会员预设为 level1 (新手限红)
5. **系统备份**：建议在调整限红前备份相关数据

### 🛠️ 故障排除

**问题**：调整限红后会员仍然可以超额投注
- **解决**：检查游戏后端是否已更新限红验证逻辑
- **确认**：确保 AGENT_API_URL 配置正确

**问题**：限红配置显示空白
- **解决**：检查资料库连接和 betting_limit_configs 表数据
- **修复**：重新运行初始化SQL脚本

**问题**：无法调整限红等级
- **解决**：确认操作者是总代理 (level 0)
- **检查**：确认会员ID和限红等级参数正确

## 测试验证

### 🧪 功能测试

使用提供的测试脚本验证功能：

```bash
node test-betting-limits.js
```

测试内容包括：
- 限红配置列表获取
- 会员限红设定查询
- 限红验证流程模拟
- API响应格式验证

### 📈 性能监控

- 监控限红验证API的响应时间
- 跟踪资料库查询性能
- 观察系统负载变化

## 版本更新

### 📋 更新日志

**v1.0.0** - 初始版本
- 实现6个等级的限红配置
- 支援动态限红调整
- 整合投注系统验证
- 添加权限控制和操作记录

### 🔄 升级指南

从固定限红升级到动态限红：

1. 执行资料库迁移脚本
2. 更新后端API代码
3. 更新前端管理界面
4. 验证功能正常运作
5. 培训操作人员使用新功能

---

如有任何问题或建议，请联系技术支援团队。 