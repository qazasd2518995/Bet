# 解决输赢控制前端500错误指南

## 🔍 问题分析

用户在代理管理平台的输赢控制功能遇到500错误：
- 创建输赢控制失败
- 载入输赢控制列表失败
- 正常机率、自动侦测、刷新都有错误

## ✅ 后端验证结果

经过测试确认后端API完全正常：
- 登入API：✅ 正常
- 列表API：✅ 正常 (GET /api/agent/win-loss-control)
- 创建API：✅ 正常 (POST /api/agent/win-loss-control)
- 删除API：✅ 正常 (NULL外键修复生效)

## 🔧 解决方案

### 1. 清除浏览器缓存
```
1. 打开开发者工具 (F12)
2. 右键点击刷新按钮
3. 选择「强制重新载入」或「Empty Cache and Hard Reload」
4. 或者使用 Ctrl+Shift+R (Windows) / Cmd+Shift+R (Mac)
```

### 2. 重新登入代理系统
```
1. 登出当前代理帐号
2. 清除浏览器会话数据：
   - 打开开发者工具 > Application > Storage
   - 清除 localStorage 和 sessionStorage
3. 重新登入代理系统
```

### 3. 检查网路连接
```
1. 确认伺服器运行正常：http://localhost:3003
2. 检查网路请求：
   - 开发者工具 > Network 标签
   - 查看失败的请求详细信息
   - 检查 Request Headers 中的 Authorization
```

### 4. 伺服器重启 (管理员操作)
```bash
# 停止代理后端
pkill -f "node.*agentBackend"

# 设置环境变数并重启
export DATABASE_URL="postgresql://justin:@localhost:5432/bet_game"
export NODE_ENV="development"
export PORT="3003"

# 启动代理后端
node agentBackend.js
```

### 5. 检查浏览器控制台错误
```
1. 打开开发者工具 (F12)
2. 查看 Console 标签中的错误详情
3. 检查是否有认证或CORS错误
4. 查看 Network 标签中失败请求的Response
```

## 🛠️ 故障排除步骤

### 步骤1：基本检查
1. 确认代理帐号密码正确 (ti2025A / ti2025A)
2. 确认伺服器运行在 http://localhost:3003
3. 检查浏览器访问的URL是否正确

### 步骤2：会话检查
1. 检查登入是否成功
2. 确认 Authorization token 是否有效
3. 检查会话是否过期

### 步骤3：API测试
```bash
# 手动测试API (在终端执行)
TOKEN=$(curl -s -X POST http://localhost:3003/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username":"ti2025A","password":"ti2025A"}' | jq -r '.sessionToken')

# 测试列表API
curl -X GET http://localhost:3003/api/agent/win-loss-control \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" | jq
```

## 📋 常见错误和解决方法

### 错误1：Authentication Failed
**解决**：重新登入，确认凭证正确

### 错误2：CORS Error
**解决**：确认伺服器CORS设置，重启伺服器

### 错误3：Database Connection Error
**解决**：检查资料库连接，设置正确的DATABASE_URL

### 错误4：Session Expired
**解决**：清除浏览器Storage，重新登入

## 🎯 最终建议

**最快解决方法**：
1. 强制刷新浏览器 (Ctrl+Shift+R)
2. 重新登入代理系统
3. 如果仍有问题，联系技术支援

**技术支援验证**：
- 后端API已确认完全正常
- 输赢控制NULL外键修复已生效
- 数据库连接稳定
- 所有核心功能运作正常 