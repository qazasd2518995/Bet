# 客服存款/提款系统操作说明

## 系统概述

本系统实现了客服专用的存款/提款记录管理功能，只有总代理（客服）可以操作所有代理和会员的余额，普通代理和会员只能查看记录。

## 权限设计

### 客服权限（总代理 level=0）
- ✅ 可以修改任何代理的余额
- ✅ 可以修改任何会员的余额  
- ✅ 可以查看所有客服操作记录
- ✅ 所有操作都会自动记录到交易表中

### 普通代理权限
- ❌ 不能修改余额
- ✅ 只能查看自己和下级的交易记录
- ✅ 可以查看客服操作记录（只读）

### 会员权限
- ❌ 不能修改余额
- ✅ 只能查看自己的交易记录

## 登入资讯

**客服帐号（总代理）:**
- 用户名: `admin`
- 密码: `adminpwd`
- 级别: 0 (总代理)

## API接口说明

### 1. 代理余额调整
```bash
POST /api/agent/cs-agent-balance
Content-Type: application/json

{
  "operatorId": 1,           # 操作员ID（必须是客服）
  "targetAgentId": 2,        # 目标代理ID
  "newBalance": 1000,        # 新余额
  "description": "客服存款"   # 操作说明（可选）
}
```

### 2. 会员余额调整
```bash
POST /api/agent/cs-member-balance
Content-Type: application/json

{
  "operatorId": 1,                    # 操作员ID（必须是客服）
  "targetMemberUsername": "xi111",    # 目标会员用户名
  "newBalance": 30000,                # 新余额
  "description": "客服调整余额"        # 操作说明（可选）
}
```

### 3. 查看客服操作记录
```bash
GET /api/agent/cs-transactions?operatorId=1&page=1&limit=20&userType=all&transactionType=all

参数说明:
- operatorId: 操作员ID（必须是客服）
- page: 页码（默认1）
- limit: 每页数量（默认20）
- userType: 用户类型筛选（all/agent/member）
- transactionType: 交易类型筛选（all/cs_deposit/cs_withdraw）
```

## 前端界面功能

### 客服操作界面
1. **交易记录标签页** - 新增「客服操作记录」标签（只有客服可见）
2. **新增操作按钮** - 可以选择代理或会员操作
3. **筛选功能** - 可按用户类型和操作类型筛选
4. **操作记录显示** - 完整的操作历史和详情

### 操作流程
1. 客服登入系统（admin/adminpwd）
2. 进入「交易记录」→「客服操作记录」
3. 点击「新增操作」按钮
4. 选择操作类型（代理/会员）
5. 选择目标用户并输入新余额
6. 填写操作说明并确认
7. 系统自动计算差额并记录

## 测试示例

### 测试代理余额调整
```bash
curl -X POST http://localhost:3003/api/agent/cs-agent-balance \
  -H "Content-Type: application/json" \
  -d '{"operatorId":1,"targetAgentId":2,"newBalance":1000,"description":"测试客服存款1000元"}'
```

### 测试会员余额调整
```bash
curl -X POST http://localhost:3003/api/agent/cs-member-balance \
  -H "Content-Type: application/json" \
  -d '{"operatorId":1,"targetMemberUsername":"xi111","newBalance":30000,"description":"客服调整会员余额"}'
```

### 查看操作记录
```bash
curl "http://localhost:3003/api/agent/cs-transactions?operatorId=1&page=1&limit=10"
```

## 资料库记录

所有客服操作都会在 `transactions` 表中留下记录：
- `type`: 'cs_deposit'（存款）或 'cs_withdraw'（提款）
- `user_type`: 'agent' 或 'member'
- `amount`: 变化金额（可正可负）
- `before_balance`: 操作前余额
- `after_balance`: 操作后余额
- `description`: 操作说明

## 安全机制

1. **权限验证**: 每个操作都会检查操作员是否为客服
2. **余额限制**: 新余额不能小于0
3. **操作记录**: 所有操作都会详细记录
4. **API保护**: 非客服帐号无法调用相关API

## 注意事项

1. 只有总代理（level=0）才能执行客服操作
2. 所有余额调整都是绝对值设定，系统会自动计算差额
3. 操作记录无法删除，保证审计完整性
4. 建议在操作说明中详细记录操作原因 