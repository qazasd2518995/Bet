# 三種帳號類型管理說明

## 帳號類型概述

系統中有三種不同的帳號類型，各自有不同的用途和權限：

### 1. 代理帳號 (agents)
- **用途**：管理會員、處理資金、查看報表
- **儲存表**：`agents`
- **登入入口**：代理管理系統 (port 3003)
- **特徵**：
  - 有層級關係（總代理 level 0 到 15級代理）
  - 可以創建下級代理和會員
  - 有退水比例設置
  - 可以進行資金操作

### 2. 會員帳號 (members)
- **用途**：進行投注、查看個人記錄
- **儲存表**：`members`
- **登入入口**：遊戲前台 (port 3000)
- **特徵**：
  - 屬於某個代理管理
  - 只能進行投注操作
  - 無法創建其他帳號
  - 資金由代理管理

### 3. 子帳號 (sub_accounts)
- **用途**：代理的輔助帳號，只能查看報表
- **儲存表**：`sub_accounts`
- **登入入口**：代理管理系統 (port 3003)
- **特徵**：
  - 屬於某個代理（每個代理最多2個子帳號）
  - 只能查看報表查詢功能
  - 無法進行任何修改操作
  - 登入後 level 設為 99 作為識別

## 用戶名唯一性規則

### 修改前的問題
- 各表獨立檢查，導致可能存在相同用戶名
- 例如：`justin2025A` 同時存在於代理表和子帳號表
- 可能造成登入混亂和權限問題

### 修改後的規則
所有用戶名必須在三個表中都保持唯一：

1. **創建代理時**：檢查 agents + members + sub_accounts
2. **創建會員時**：檢查 members + agents + sub_accounts  
3. **創建子帳號時**：檢查 sub_accounts + agents + members

### 錯誤提示
- 被代理使用：「該用戶名已被使用（代理）」
- 被會員使用：「該用戶名已被使用（會員）」
- 被子帳號使用：「該用戶名已被使用（子帳號）」

## 登入流程

### 代理系統登入 (`/api/agent/login`)
1. 先查詢 agents 表
2. 如果不是代理，查詢 sub_accounts 表
3. 根據帳號類型設置不同的權限標記

### 會員系統登入 (`/api/member/login`)
1. 只查詢 members 表
2. 通過代理系統 API 驗證

## 權限區別

| 功能 | 代理 | 會員 | 子帳號 |
|------|------|------|--------|
| 創建代理 | ✓ (根據層級) | ✗ | ✗ |
| 創建會員 | ✓ | ✗ | ✗ |
| 創建子帳號 | ✓ | ✗ | ✗ |
| 資金操作 | ✓ | ✗ | ✗ |
| 查看報表 | ✓ | ✗ | ✓ |
| 系統公告 | ✓ | ✗ | ✗ |
| 投注功能 | ✗ | ✓ | ✗ |

## 資料庫約束

- `agents.username`: UNIQUE 約束
- `members.username`: UNIQUE 約束
- `sub_accounts.username`: 應該添加 UNIQUE 約束

## 建議的清理操作

對於現有的重複用戶名（如 justin2025A），建議：
1. 保留代理帳號
2. 刪除或重命名子帳號
3. 確保未來不會再出現重複

## 安全考量

1. **避免用戶混淆**：統一的用戶名空間避免用戶輸錯系統
2. **權限隔離**：不同類型帳號有明確的權限邊界
3. **審計追蹤**：所有操作都可以追溯到唯一的用戶