# 极速赛车代理管理与退水系统

## 系统概述

本系统实现了完整的代理层级管理和退水分配机制，确保了金钱流转的透明和准确性。

## 主要功能

### 1. 代理层级管理

#### 层级导航
- **面包屑导航**：清晰显示当前管理的代理层级
- **进入下级**：点击代理用户名可进入该代理的下级管理
- **返回上级**：提供返回按钮快速回到上级层级
- **层级限制**：每级代理只能创建比自己低一级的下级代理

#### 代理创建
- **基本资讯**：用户名、密码、代理级别
- **佣金设定**：可设定代理佣金比例（%）
- **退水模式**：
  - 全拿所有退水：该代理获得所有可得退水
  - 设定具体比例：自定义退水比例
  - 全退给下级：不获得退水，全部给下级

### 2. 退水系统

#### 退水计算
- **基础退水率**：4.1%（从会员下注金额中扣除）
- **分配原则**：按代理层级和设定进行分配
- **计算公式**：总退水金额 = 下注金额 × 4.1%

#### 退水分配逻辑
```
会员下注 → 扣除赔率差额(4.1%) → 按代理链分配退水

分配顺序：直属代理 → 上级代理 → ... → 总代理
分配方式：
- 全拿模式：该代理拿走所有剩余退水，分配结束
- 比例模式：按设定比例从总退水中分配
- 全退模式：该代理不拿退水，留给上级
```

### 3. 金钱流转逻辑

#### 会员下注流程
1. **下注扣除**：从会员余额扣除下注金额
2. **赔率计算**：使用包含退水的赔率（原赔率 × (1-4.1%)）
3. **退水分配**：按代理层级分配4.1%的退水
4. **派彩处理**：中奖时直接增加会员余额

#### 资金安全保障
- **无中生有防护**：所有资金增减都有明确来源
- **无中损失防护**：退水总额不会超过可分配金额
- **余额同步**：主系统与代理系统余额实时同步
- **交易记录**：所有资金流动都有完整记录

## 技术实现

### 后端API

#### 主后端（backend.js）
- `distributeRebate(username, betAmount)`：退水分配主函数
- `getAgentChain(username)`：获取会员代理链
- `allocateRebateToAgent()`：分配退水给具体代理

#### 代理后端（agentBackend.js）
- `GET /api/member-agent-chain`：获取会员代理链
- `POST /api/allocate-rebate`：分配退水给代理
- `PUT /api/update-rebate-settings/:agentId`：更新退水设定

### 前端功能

#### 层级导航
- 面包屑导航显示当前层级路径
- 点击代理名称进入下级管理
- 返回按钮快速回到上级

#### 退水设定
- 创建代理时设定退水模式
- 创建后可调整退水设定
- 实时显示当前退水配置

## 数据库结构

### 代理表（agents）
```sql
- rebate_percentage: 退水比例（小数）
- rebate_mode: 退水模式（'all'/'percentage'/'none'）
- max_rebate_percentage: 最大可设定退水比例
```

### 交易记录（transactions）
```sql
- type: 'rebate' 表示退水交易
- description: 详细说明退水来源
- balance_after: 交易后余额
```

## 使用流程

### 代理管理员操作
1. 登入代理管理系统
2. 在代理管理页面查看下级代理
3. 点击「新增代理」创建下级代理
4. 设定退水模式和比例
5. 点击代理名称进入下级管理
6. 使用「退水设定」按钮调整设定

### 会员下注流程
1. 会员在游戏介面下注
2. 系统扣除下注金额
3. 开奖后自动结算输赢
4. 同时分配退水给代理链
5. 代理可在交易记录中查看退水收入

## 系统优势

### 透明度
- 所有资金流动都有记录
- 退水分配逻辑清晰可追踪
- 代理层级关系一目了然

### 灵活性
- 多种退水模式适应不同需求
- 可随时调整退水设定
- 支援无限层级代理结构

### 安全性
- 严格的金额验证机制
- 防止资金异常增减
- 完整的错误处理机制

## 注意事项

1. **退水设定**：下级代理的退水比例不能超过上级代理设定的最大值
2. **资金流向**：退水资金来源于会员下注，不会凭空产生
3. **层级限制**：代理只能管理直属下级，不能跨级管理
4. **即时结算**：退水在每次下注结算时立即分配

## 故障排除

### 常见问题
1. **退水未到帐**：检查代理链设定和系统日志
2. **层级导航错误**：确认代理关系正确设定
3. **余额不一致**：检查同步机制和网路连接

### 维护建议
1. 定期检查交易记录的一致性
2. 监控退水分配的总金额
3. 备份代理关系和设定数据 