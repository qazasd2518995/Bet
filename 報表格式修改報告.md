# 报表格式修改报告

## 修改日期
2024-12-24

## 更新日期
2024-12-24 (第二次修改)

## 修改内容概述

本次修改主要针对代理管理平台的报表查询功能进行了重大的表格格式优化，使其更符合专业博彩系统的规范和用户需求。

## 主要修改项目

### 1. 下注记录日期栏位优化
- **修改前**：有三个日期栏位：日期、开始日期、结束日期（重复且混乱）
- **修改后**：删除单独的"日期"栏位，只保留"开始日期"和"结束日期"
- **优化布局**：将原本的 col-md-2 改为 col-md-3，提供更宽敞的输入空间

### 2. 报表查询表格结构重新设计

#### 2.1 表头结构优化
- **修改前**：单层表头，所有栏位平铺
- **修改后**：采用双层表头结构
  - 第一层：分组标题（会员输赢、代理级别名称）
  - 第二层：具体栏位

#### 2.2 栏位重新组织
新的栏位结构如下：

**基础数据**
- 用户名（支持点击跳转）
- 下注金额
- 有效金额

**会员输赢组**
- 输赢（反转显示，从代理视角看）
- 退水
- 盈亏结果

**代理数据组**（动态显示当前代理级别）
- 占成（目前为0%）
- 占成金额（目前为0.00）
- 占成结果（目前为0.00）
- 实占退水（显示实际退水百分比）
- 赚水（退水利润）
- 盈亏结果（代理最终盈亏）
- 上交货量（等于总下注金额）
- 上级交收（应收下线 + 盈亏结果）

### 3. 数据逻辑调整

#### 3.1 会员输赢显示逻辑
- **原逻辑**：直接显示 memberWinLoss
- **新逻辑**：显示 -memberWinLoss（反转符号）
- **原因**：从代理视角看，会员赢钱代表代理输钱

#### 3.2 上级交收计算
- **公式**：-item.profitLoss - item.rebateProfit
- **含义**：应收下线金额加上代理的盈亏结果

#### 3.3 赚水逻辑
- **显示内容**：rebateProfit（退水利润）
- **说明**：代理从退水中获得的利润

### 4. 视觉优化

#### 4.1 颜色方案
- 保持原有的盈亏颜色逻辑（红色亏损、绿色盈利）
- 退水相关栏位使用 badge-warning（黄色）
- 占成相关栏位使用 badge-info（蓝色）

#### 4.2 表格样式
- 添加 table-sm 类，使表格更紧凑
- 调整最小宽度设定，确保数据不会挤压

### 5. 动态级别显示
- 表头会根据当前浏览的代理级别动态显示
- 如果在面包屑导航中，显示当前级别
- 否则显示登入用户的级别

## 技术实现细节

### 前端文件修改
1. `agent/frontend/index.html`
   - 修改下注记录筛选表单
   - 重构报表查询表格结构

2. `deploy/frontend/index.html`
   - 同步所有修改到生产版本

### 关键代码片段

```html
<!-- 双层表头结构 -->
<tr style="background-color: #2c3e50;">
    <th rowspan="2">用户名</th>
    <th rowspan="2">下注金额</th>
    <th rowspan="2">有效金额</th>
    <th colspan="3">会员输赢</th>
    <th colspan="7">{{ 动态级别名称 }}</th>
</tr>
```

```javascript
// 上级交收计算
{{ formatProfit(-item.profitLoss - item.rebateProfit) }}
```

## 影响范围
- 下注记录查询功能
- 报表查询功能
- 相关的数据展示逻辑

## 后续建议
1. 实现真正的占成功能，替换目前的占位数据
2. 添加更多的统计指标
3. 考虑添加图表视觉化功能
4. 优化移动端显示效果

## 测试重点
1. 确认日期范围查询功能正常
2. 验证所有数据计算逻辑正确
3. 测试点击跳转功能
4. 检查不同级别代理的显示效果

## 版本控制
- 已同步修改到主版本和deploy版本
- 建议进行完整的功能测试后再部署到生产环境

## 第二次修改内容 (2024-12-24)

### 报表表格结构调整

1. **新增"应收下线"栏位**
   - 位置：在"占成"左边
   - 计算逻辑：-item.profitLoss（会员盈亏的反转）
   - 含义：代理应收下线的金额

2. **调整分组结构**
   - 代理组栏位从7个减少到6个（移除了"实占退水"）
   - "上交货量"和"上级交收"改为独立栏位，不属于任何分组
   - 使用 rowspan="2" 让这两个栏位跨越两行

3. **栏位顺序调整**
   新的栏位顺序：
   - 用户名
   - 下级金额
   - 有效金额
   - **会员输赢组**：输赢、退水、盈亏结果
   - **代理组**：应收下线、占成、占成金额、占成结果、赚水、盈亏结果
   - **独立栏位**：上交货量、上级交收

### 修改的文件
- agent/frontend/index.html
- deploy/frontend/index.html
- 更新报表格式修改报告.md 