<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代理管理系統</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/main.css">
</head>
<body>
    <div id="app">
        <!-- 登入頁面 -->
        <div v-if="!isLoggedIn" class="container login-container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h3 class="text-center mb-0">代理管理系統</h3>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="login">
                                <div class="form-group mb-3">
                                    <label for="username">用戶名</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" id="username" v-model="loginForm.username" class="form-control" placeholder="請輸入用戶名" required>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="password">密碼</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        <input type="password" id="password" v-model="loginForm.password" class="form-control" placeholder="請輸入密碼" required>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="remember">
                                        <label class="form-check-label" for="remember">記住我</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary" :disabled="loading">
                                        <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                        登入
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主頁面 -->
        <div v-else>
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">代理管理系統</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'dashboard'}" href="#" @click="activeTab = 'dashboard'">儀表板</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'agents'}" href="#" @click="activeTab = 'agents'">代理管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'members'}" href="#" @click="activeTab = 'members'">會員管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'transactions'}" href="#" @click="activeTab = 'transactions'">交易記錄</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'stats'}" href="#" @click="activeTab = 'stats'">統計數據</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'draw'}" href="#" @click="activeTab = 'draw'">開獎記錄</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'notices'}" href="#" @click="activeTab = 'notices'">系統公告</a>
                            </li>
                        </ul>
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-circle me-1"></i>{{ user.username }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" @click="activeTab = 'profile'">個人資料</a></li>
                                    <li><a class="dropdown-item" href="#" @click="activeTab = 'settings'">帳號設置</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" @click="logout">登出</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="container-fluid mt-3">
                <!-- 儀表板 -->
                <div v-if="activeTab === 'dashboard'">
                    <h2>儀表板</h2>
                    <div class="row mt-4">
                        <div class="col-md-3 mb-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5 class="card-title">總代理數</h5>
                                    <h2 class="card-text">{{ dashboardData.totalAgents }}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">總會員數</h5>
                                    <h2 class="card-text">{{ dashboardData.totalMembers }}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5 class="card-title">今日交易量</h5>
                                    <h2 class="card-text">{{ formatMoney(dashboardData.todayTransactions) }}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5 class="card-title">本月佣金</h5>
                                    <h2 class="card-text">{{ formatMoney(dashboardData.monthlyCommission) }}</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    近期交易趨勢
                                </div>
                                <div class="card-body">
                                    <canvas id="transactionChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    系統公告
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li v-for="notice in notices" :key="notice.id" class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>{{ notice.title }}</span>
                                            <span class="badge bg-primary rounded-pill">{{ formatDate(notice.createTime) }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 代理管理 -->
                <div v-if="activeTab === 'agents'">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>代理管理</h2>
                        <button class="btn btn-primary" @click="showAgentModal">
                            <i class="fas fa-plus me-1"></i>新增代理
                        </button>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            搜尋條件
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">代理級別</label>
                                    <select class="form-select" v-model="agentFilters.level">
                                        <option value="-1">全部</option>
                                        <option value="0">總代理</option>
                                        <option value="1">一級代理</option>
                                        <option value="2">二級代理</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">狀態</label>
                                    <select class="form-select" v-model="agentFilters.status">
                                        <option value="-1">全部</option>
                                        <option value="1">啟用</option>
                                        <option value="0">停用</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">關鍵字</label>
                                    <input type="text" class="form-control" placeholder="用戶名/ID" v-model="agentFilters.keyword">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" @click="searchAgents">搜尋</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用戶名</th>
                                            <th>級別</th>
                                            <th>上級</th>
                                            <th>餘額</th>
                                            <th>佣金比例</th>
                                            <th>創建時間</th>
                                            <th>狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="agent in agents" :key="agent.id">
                                            <td>{{ agent.id }}</td>
                                            <td>{{ agent.username }}</td>
                                            <td>{{ getLevelName(agent.level) }}</td>
                                            <td>{{ agent.parent || '-' }}</td>
                                            <td>{{ formatMoney(agent.balance) }}</td>
                                            <td>{{ (agent.commission * 100) + '%' }}</td>
                                            <td>{{ formatDate(agent.createdAt) }}</td>
                                            <td>
                                                <span :class="agent.status === 1 ? 'badge bg-success' : 'badge bg-danger'">
                                                    {{ agent.status === 1 ? '啟用' : '停用' }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-outline-info" @click="viewAgentDetails(agent)">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-primary" @click="editAgent(agent)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" @click="toggleAgentStatus(agent)">
                                                        <i :class="agent.status === 1 ? 'fas fa-ban' : 'fas fa-check'"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <nav v-if="agentPagination.totalPages > 1">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" :class="{disabled: agentPagination.currentPage === 1}">
                                        <a class="page-link" href="#" @click.prevent="changePage(agentPagination.currentPage - 1, 'agents')">上一頁</a>
                                    </li>
                                    <li class="page-item" v-for="page in agentPagination.totalPages" :key="page" :class="{active: page === agentPagination.currentPage}">
                                        <a class="page-link" href="#" @click.prevent="changePage(page, 'agents')">{{ page }}</a>
                                    </li>
                                    <li class="page-item" :class="{disabled: agentPagination.currentPage === agentPagination.totalPages}">
                                        <a class="page-link" href="#" @click.prevent="changePage(agentPagination.currentPage + 1, 'agents')">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                    <!-- 新增代理 Modal -->
                    <div class="modal" id="createAgentModal" tabindex="-1" v-if="showCreateAgentModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">新增代理</h5>
                                    <button type="button" class="btn-close" @click="hideCreateAgentModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="createAgent">
                                        <div class="mb-3">
                                            <label class="form-label">用戶名</label>
                                            <input type="text" class="form-control" v-model="newAgent.username" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">密碼</label>
                                            <input type="password" class="form-control" v-model="newAgent.password" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">代理級別</label>
                                            <select class="form-select" v-model="newAgent.level" required>
                                                <option value="0">總代理</option>
                                                <option value="1">一級代理</option>
                                                <option value="2">二級代理</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">上級代理</label>
                                            <select class="form-select" v-model="newAgent.parent">
                                                <option value="">無</option>
                                                <option v-for="agent in parentAgents" :key="agent.id" :value="agent.id">
                                                    {{ agent.username }} ({{ agent.id }})
                                                </option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">佣金比例</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" v-model="newAgent.commission" step="0.01" min="0" max="1" required>
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" @click="hideCreateAgentModal">取消</button>
                                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                                建立
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 編輯代理 Modal -->
                    <div class="modal" id="editAgentModal" tabindex="-1" v-if="showEditAgentModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">編輯代理</h5>
                                    <button type="button" class="btn-close" @click="hideEditAgentModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="updateAgent">
                                        <div class="mb-3">
                                            <label class="form-label">代理ID</label>
                                            <input type="text" class="form-control" v-model="editAgentData.id" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">用戶名</label>
                                            <input type="text" class="form-control" v-model="editAgentData.username" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">修改密碼 (留空表示不修改)</label>
                                            <input type="password" class="form-control" v-model="editAgentData.password">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">佣金比例</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" v-model="editAgentData.commission" step="0.01" min="0" max="1" required>
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">狀態</label>
                                            <select class="form-select" v-model="editAgentData.status">
                                                <option value="1">啟用</option>
                                                <option value="0">停用</option>
                                            </select>
                                        </div>
                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" @click="hideEditAgentModal">取消</button>
                                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                                更新
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 會員管理 -->
                <div v-if="activeTab === 'members'">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>會員管理</h2>
                        <button class="btn btn-primary" @click="showMemberModal">
                            <i class="fas fa-plus me-1"></i>新增會員
                        </button>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            搜尋條件
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">狀態</label>
                                    <select class="form-select" v-model="memberFilters.status">
                                        <option value="-1">全部</option>
                                        <option value="1">啟用</option>
                                        <option value="0">停用</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">關鍵字</label>
                                    <input type="text" class="form-control" placeholder="用戶名/ID" v-model="memberFilters.keyword">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-primary" @click="searchMembers">搜尋</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用戶名</th>
                                            <th>餘額</th>
                                            <th>狀態</th>
                                            <th>創建時間</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="members.length === 0">
                                            <td colspan="6" class="text-center">無會員數據</td>
                                        </tr>
                                        <tr v-for="member in members" :key="member.id">
                                            <td>{{ member.id }}</td>
                                            <td>{{ member.username }}</td>
                                            <td>{{ formatMoney(member.balance) }}</td>
                                            <td>
                                                <span class="badge" :class="member.status === 1 ? 'bg-success' : 'bg-danger'">
                                                    {{ member.status === 1 ? '啟用' : '停用' }}
                                                </span>
                                            </td>
                                            <td>{{ formatDate(member.created_at) }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" @click="viewMemberDetails(member)" title="查看詳情">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-success" @click="adjustMemberBalance(member)" title="調整餘額">
                                                        <i class="fas fa-money-bill-wave"></i>
                                                    </button>
                                                    <button class="btn btn-outline-warning" @click="editMember(member)" title="編輯">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" @click="toggleMemberStatus(member)" title="停用/啟用">
                                                        <i class="fas" :class="member.status === 1 ? 'fa-ban' : 'fa-check'"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <nav v-if="memberPagination.totalPages > 1">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" :class="{disabled: memberPagination.currentPage === 1}">
                                        <a class="page-link" href="#" @click.prevent="changePage(memberPagination.currentPage - 1, 'members')">上一頁</a>
                                    </li>
                                    <li class="page-item" v-for="page in memberPagination.totalPages" :key="page" :class="{active: page === memberPagination.currentPage}">
                                        <a class="page-link" href="#" @click.prevent="changePage(page, 'members')">{{ page }}</a>
                                    </li>
                                    <li class="page-item" :class="{disabled: memberPagination.currentPage === memberPagination.totalPages}">
                                        <a class="page-link" href="#" @click.prevent="changePage(memberPagination.currentPage + 1, 'members')">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                    <!-- 新增會員 Modal -->
                    <div class="modal" id="createMemberModal" tabindex="-1" v-if="showCreateMemberModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">新增會員</h5>
                                    <button type="button" class="btn-close" @click="hideCreateMemberModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="createMember">
                                        <div class="mb-3">
                                            <label class="form-label">用戶名</label>
                                            <input type="text" class="form-control" v-model="newMember.username" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">密碼</label>
                                            <input type="password" class="form-control" v-model="newMember.password" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">確認密碼</label>
                                            <input type="password" class="form-control" v-model="newMember.confirmPassword" required>
                                        </div>
                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" @click="hideCreateMemberModal">取消</button>
                                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                                建立
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 會員餘額調整模態框 -->
                    <div class="modal" id="adjustBalanceModal" tabindex="-1" v-if="showAdjustBalanceModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">調整會員餘額</h5>
                                    <button type="button" class="btn-close" @click="hideAdjustBalanceModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="submitBalanceAdjustment">
                                        <div class="mb-3">
                                            <label class="form-label">會員名稱</label>
                                            <input type="text" class="form-control" v-model="balanceAdjustData.username" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">目前餘額</label>
                                            <input type="text" class="form-control" :value="formatMoney(balanceAdjustData.currentBalance)" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">調整方式</label>
                                            <select class="form-select" v-model="balanceAdjustData.adjustType">
                                                <option value="increment">增加金額</option>
                                                <option value="decrement">減少金額</option>
                                                <option value="set">設置為指定金額</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">{{ balanceAdjustData.adjustType === 'set' ? '新餘額' : '調整金額' }}</label>
                                            <input type="number" class="form-control" v-model="balanceAdjustData.amount" min="0" step="0.01" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">備註</label>
                                            <textarea class="form-control" v-model="balanceAdjustData.comment" placeholder="請輸入調整原因"></textarea>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-secondary me-2" @click="hideAdjustBalanceModal">取消</button>
                                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm me-1"></span>
                                                確認調整
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入必要的 JS 庫 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 載入主要 JS 檔案 -->
    <script src="./js/main.js"></script>
</body>
</html>