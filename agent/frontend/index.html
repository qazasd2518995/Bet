<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代理管理系統</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/main.css">
    <style>
        /* 基本樣式 */
        body {
            font-family: 'Microsoft JhengHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
        }
        /* ... 其他現有樣式 ... */

        /* 添加球號顏色規則 */
        .number-ball {
            width: 28px; /* 根據需要調整大小 */
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px; /* 根據需要調整大小 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            margin: 0 2px; /* 添加一些間距 */
            color: #fff; /* 預設文字顏色 */
        }

        /* 與遊戲前端一致的顏色 */
        .color-1 { background-color: #ffcc00; color: #000; } /* 金黃色 */
        .color-2 { background-color: #3399ff; color: #fff; } /* 鮮藍色 */
        .color-3 { background-color: #777777; color: #fff; } /* 深灰色 */
        .color-4 { background-color: #ff9933; color: #fff; } /* 橙色 */
        .color-5 { background-color: #00ccff; color: #fff; } /* 天藍色 */
        .color-6 { background-color: #9966cc; color: #fff; } /* 紫色 */
        .color-7 { background-color: #aaaaaa; color: #fff; } /* 灰色 */
        .color-8 { background-color: #ff3333; color: #fff; } /* 紅色 */
        .color-9 { background-color: #990000; color: #fff; } /* 深紅色 */
        .color-10 { background-color: #33cc33; color: #fff; } /* 綠色 */
    </style>
</head>
<body>
    <div id="app">
        <!-- 登入頁面 -->
        <div v-if="!isLoggedIn" class="container login-container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h3 class="text-center mb-0">代理管理系統</h3>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="login">
                                <div class="form-group mb-3">
                                    <label for="username">用戶名</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" id="username" v-model="loginForm.username" class="form-control" placeholder="請輸入用戶名" required>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="password">密碼</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        <input type="password" id="password" v-model="loginForm.password" class="form-control" placeholder="請輸入密碼" required>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="remember">
                                        <label class="form-check-label" for="remember">記住我</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary" :disabled="loading">
                                        <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                        登入
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主頁面 -->
        <div v-else>
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">代理管理系統</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'dashboard'}" href="#" @click="setActiveTab('dashboard')">儀表板</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'agents'}" href="#" @click="setActiveTab('agents')">代理管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'members'}" href="#" @click="setActiveTab('members')">會員管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'transactions'}" href="#" @click="setActiveTab('transactions')">交易記錄</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'stats'}" href="#" @click="setActiveTab('stats')">下注記錄</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'draw'}" href="#" @click="setActiveTab('draw')">開獎記錄</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: activeTab === 'notices'}" href="#" @click="setActiveTab('notices')">系統公告</a>
                            </li>
                            <li class="nav-item" v-if="user.level === 0">
                                <a class="nav-link" :class="{active: activeTab === 'customer-service'}" href="#" @click="setActiveTab('customer-service')">客服功能</a>
                            </li>
                        </ul>
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item me-3">
                                <a class="nav-link">
                                    <i class="fas fa-wallet me-1"></i>額度: {{ formatMoney(user.balance) }}
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-circle me-1"></i>{{ user.username }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" @click.prevent="showProfileModal()">
                                        <i class="fas fa-user-edit me-2"></i>個人資料
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" @click="logout">
                                        <i class="fas fa-sign-out-alt me-2"></i>登出
                                    </a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="container-fluid mt-3">
                <!-- 儀表板 -->
                <div v-if="activeTab === 'dashboard'">
                    <h2>儀表板</h2>
                    <!-- 第一排卡片 - 4個主要指標 -->
                    <div class="row mt-4">
                        <div class="col-md-3 mb-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">我的點數餘額</h5>
                                            <h2 class="card-text mb-0">{{ formatMoney(user.balance) }}</h2>
                                        </div>
                                        <i class="fas fa-wallet fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">總會員數</h5>
                                            <h2 class="card-text mb-0">{{ dashboardData.memberCount }}</h2>
                                        </div>
                                        <i class="fas fa-users fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">今日投注額</h5>
                                            <h2 class="card-text mb-0">{{ formatMoney(dashboardData.totalTransactions) }}</h2>
                                        </div>
                                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">下級代理數</h5>
                                            <h2 class="card-text mb-0">{{ dashboardData.subAgentsCount }}</h2>
                                        </div>
                                        <i class="fas fa-sitemap fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 第二排卡片 - 詳細統計 -->
                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <div class="card bg-light border-start border-primary border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted mb-1">活躍會員</h6>
                                            <h4 class="text-primary mb-0">{{ dashboardData.activeMembers }}</h4>
                                        </div>
                                        <i class="fas fa-user-check fa-lg text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-light border-start border-success border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                                                        <h6 class="text-muted mb-1">代理盈利</h6>
                            <h4 class="text-success mb-0">{{ formatMoney(dashboardData.totalDeposit) }}</h4>
                                        </div>
                                        <i class="fas fa-arrow-up fa-lg text-success"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-light border-start border-danger border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                                                        <h6 class="text-muted mb-1">代理虧損</h6>
                            <h4 class="text-danger mb-0">{{ formatMoney(dashboardData.totalWithdraw) }}</h4>
                                        </div>
                                
                                        <i class="fas fa-arrow-down fa-lg text-danger"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card bg-light border-start border-info border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted mb-1">今日淨收益</h6>
                                            <h4 class="mb-0" :class="dashboardData.totalRevenue >= 0 ? 'text-success' : 'text-danger'">
                                                {{ formatMoney(dashboardData.totalRevenue) }}
                                            </h4>
                                        </div>
                                        <i class="fas fa-coins fa-lg text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 第三排 - 圖表和公告 -->
                    <div class="row">
                        <div class="col-md-8 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">近期交易趨勢</h5>
                                    <small class="text-muted">過去7天數據</small>
                                </div>
                                <div class="card-body">
                                    <canvas id="transactionChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">系統公告</h5>
                                    <button class="btn btn-sm btn-outline-primary" @click="setActiveTab('notices')">
                                        查看全部
                                    </button>
                                </div>
                                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                                    <div v-if="notices.length === 0" class="p-3 text-center text-muted">
                                        <i class="fas fa-bullhorn fa-2x mb-2"></i>
                                        <div>暫無公告</div>
                                    </div>
                                    <div v-for="notice in notices.slice(0, 5)" :key="notice.id" class="border-bottom p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ notice.title }}</h6>
                                                <p class="mb-1 text-muted small">{{ notice.content.substring(0, 50) }}...</p>
                                                <small class="text-muted">{{ formatDate(notice.created_at) }}</small>
                                            </div>
                                            <span class="badge" :class="{
                                                'bg-primary': notice.category === '最新公告',
                                                'bg-warning': notice.category === '維修',
                                                'bg-success': notice.category === '活動'
                                            }">{{ notice.category }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 第四排 - 快捷操作 -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">快捷操作</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <button class="btn btn-outline-primary w-100" @click="setActiveTab('agents')">
                                                <i class="fas fa-users-cog mb-1"></i><br>
                                                <small>代理管理</small>
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-outline-success w-100" @click="setActiveTab('members')">
                                                <i class="fas fa-user-friends mb-1"></i><br>
                                                <small>會員管理</small>
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-outline-info w-100" @click="setActiveTab('transactions')">
                                                <i class="fas fa-exchange-alt mb-1"></i><br>
                                                <small>交易記錄</small>
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-outline-warning w-100" @click="setActiveTab('stats')">
                                                <i class="fas fa-dice mb-1"></i><br>
                                                <small>下注記錄</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">系統狀態</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="text-success">
                                                <i class="fas fa-server fa-2x mb-2"></i>
                                                <div>系統正常</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-primary">
                                                <i class="fas fa-database fa-2x mb-2"></i>
                                                <div>數據同步</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-info">
                                                <i class="fas fa-wifi fa-2x mb-2"></i>
                                                <div>連線穩定</div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="text-center">
                                        <small class="text-muted">
                                            最後更新：{{ new Date().toLocaleString() }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 代理管理 -->
                <div v-if="activeTab === 'agents'">
                    <!-- 導航路徑 -->
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="#" @click.prevent="navigateToAgentLevel(user.id, user.username)" 
                                   class="text-decoration-none">
                                    {{ user.username }} ({{ getLevelName(user.level) }})
                                </a>
                            </li>
                            <li v-for="(breadcrumb, index) in agentBreadcrumbs" :key="breadcrumb.id" 
                                class="breadcrumb-item" 
                                :class="{ active: index === agentBreadcrumbs.length - 1 }">
                                <a v-if="index !== agentBreadcrumbs.length - 1" 
                                   href="#" @click.prevent="navigateToAgentLevel(breadcrumb.id, breadcrumb.username)" 
                                   class="text-decoration-none">
                                    {{ breadcrumb.username }} ({{ getLevelName(breadcrumb.level) }})
                                </a>
                                <span v-else>{{ breadcrumb.username }} ({{ getLevelName(breadcrumb.level) }})</span>
                            </li>
                        </ol>
                    </nav>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>
                            {{ currentManagingAgent.id === user.id ? '我的下級代理' : currentManagingAgent.username + ' 的下級管理' }}
                        </h2>
                        <div>
                            <button v-if="agentBreadcrumbs.length > 0" class="btn btn-secondary me-2" @click="goBackToParentLevel">
                                <i class="fas fa-arrow-left me-1"></i>返回上級
                            </button>
                            <button class="btn btn-success me-2" @click="showMemberModal">
                                <i class="fas fa-user-plus me-1"></i>新增會員
                            </button>
                            <button class="btn btn-primary" @click="showAgentModal">
                                <i class="fas fa-plus me-1"></i>新增代理
                            </button>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            搜尋條件
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">狀態</label>
                                    <select class="form-select" v-model="agentFilters.status">
                                        <option value="-1">全部</option>
                                        <option value="1">啟用</option>
                                        <option value="0">停用</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">關鍵字</label>
                                    <input type="text" class="form-control" placeholder="用戶名/ID" v-model="agentFilters.keyword">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" @click="searchAgents">搜尋</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用戶名</th>
                                            <th>級別</th>
                                            <th>餘額</th>
                                            <th>退水設定</th>
                                            <th>創建時間</th>
                                            <th>狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="agent in agents" :key="agent.id">
                                            <td>{{ agent.id }}</td>
                                            <td>
                                                <a href="#" @click.prevent="enterAgentManagement(agent)" 
                                                   class="text-decoration-none fw-bold">
                                                    {{ agent.username }}
                                                    <i class="fas fa-arrow-right ms-1 text-muted"></i>
                                                </a>
                                            </td>
                                            <td>{{ getLevelName(agent.level) }}</td>
                                            <td>{{ formatMoney(agent.balance) }}</td>
                                            <td>
                                                <span class="badge bg-info">
                                                    {{ getRebateModeText(agent.rebate_mode) }}
                                                    {{ agent.rebate_mode === 'percentage' ? ` ${(agent.rebate_percentage * 100).toFixed(1)}%` : '' }}
                                                </span>
                                            </td>
                                            <td>{{ formatDate(agent.created_at) }}</td>
                                            <td>
                                                <span :class="agent.status === 1 ? 'badge bg-success' : 'badge bg-danger'">
                                                    {{ agent.status === 1 ? '啟用' : '停用' }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" @click="adjustAgentBalance(agent)">
                                                        <i class="fas fa-exchange-alt me-1"></i>點數轉移
                                                    </button>
                                                    <button class="btn btn-outline-info" @click="showRebateSettingsModal(agent)">
                                                        <i class="fas fa-percent me-1"></i>退水設定
                                                    </button>
                                                    <button class="btn btn-outline-warning" @click="resetAgentPassword(agent)">
                                                        <i class="fas fa-key me-1"></i>重設密碼
                                                    </button>
                                                    <button class="btn" :class="agent.status === 1 ? 'btn-outline-danger' : 'btn-outline-success'" 
                                                            @click="toggleAgentStatus(agent)">
                                                        <i class="fas" :class="agent.status === 1 ? 'fa-ban' : 'fa-check'"></i>
                                                        {{ agent.status === 1 ? '停用' : '啟用' }}
                                                    </button>
                                                    <button class="btn btn-outline-danger" @click="deleteAgent(agent.id, agent.username)">
                                                        <i class="fas fa-trash-alt me-1"></i>刪除
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div v-if="agents.length === 0" class="text-center py-4">
                                <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                                <p class="text-muted">目前沒有下級代理</p>
                                <button class="btn btn-primary" @click="showAgentModal">
                                    <i class="fas fa-plus me-1"></i>立即新增代理
                                </button>
                            </div>

                            <nav v-if="agentPagination.totalPages > 1">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" :class="{disabled: agentPagination.currentPage === 1}">
                                        <a class="page-link" href="#" @click.prevent="changePage(agentPagination.currentPage - 1, 'agents')">上一頁</a>
                                    </li>
                                    <li class="page-item" v-for="page in agentPagination.totalPages" :key="page" :class="{active: page === agentPagination.currentPage}">
                                        <a class="page-link" href="#" @click.prevent="changePage(page, 'agents')">{{ page }}</a>
                                    </li>
                                    <li class="page-item" :class="{disabled: agentPagination.currentPage === agentPagination.totalPages}">
                                        <a class="page-link" href="#" @click.prevent="changePage(agentPagination.currentPage + 1, 'agents')">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                    <!-- 新增代理 Modal -->
                    <div class="modal" id="createAgentModal" tabindex="-1" v-if="showCreateAgentModal">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">新增代理</h5>
                                    <button type="button" class="btn-close" @click="hideCreateAgentModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="createAgent">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">用戶名</label>
                                                    <input type="text" class="form-control" v-model="newAgent.username" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">密碼</label>
                                                    <input type="password" class="form-control" v-model="newAgent.password" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">代理級別</label>
                                                    <select class="form-select" v-model="newAgent.level" required disabled>
                                                        <option v-for="i in 16" :key="i-1" :value="(i-1).toString()" v-if="i-1 === currentManagingAgent.level + 1">
                                                            {{ getLevelName(i-1) }}
                                                        </option>
                                                    </select>
                                                    <small class="form-text text-muted">您只能創建比目前層級低一級的代理</small>
                                                </div>

                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">退水模式</label>
                                                    <select class="form-select" v-model="newAgent.rebate_mode" required>
                                                        <option value="all">全拿所有退水</option>
                                                        <option value="percentage">設定具體比例</option>
                                                        <option value="none">全退給下級</option>
                                                    </select>
                                                    <small class="form-text text-muted">退水分配方式</small>
                                                </div>
                                                <div class="mb-3" v-if="newAgent.rebate_mode === 'percentage'">
                                                    <label class="form-label">退水比例 (%)</label>
                                                    <input type="number" class="form-control" v-model="newAgent.rebate_percentage" 
                                                           step="0.01" min="0" :max="currentManagingAgent.max_rebate_percentage * 100" required>
                                                    <small class="form-text text-muted">
                                                        可設定範圍：0% - {{ (currentManagingAgent.max_rebate_percentage * 100).toFixed(1) }}%
                                                    </small>
                                                </div>
                                                <div class="card bg-light">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">退水說明</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <ul class="mb-0 small">
                                                            <li><strong>全拿所有退水：</strong>該代理獲得所有可得退水 ({{ (currentManagingAgent.max_rebate_percentage * 100).toFixed(1) }}%)</li>
                                                            <li><strong>設定具體比例：</strong>該代理獲得指定比例的退水</li>
                                                            <li><strong>全退給下級：</strong>該代理不獲得退水，全部給下級代理</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" v-model="newAgent.parent">

                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" @click="hideCreateAgentModal">取消</button>
                                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                                建立
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 退水設定 Modal -->
                    <div class="modal" id="rebateSettingsModal" tabindex="-1" v-if="showRebateModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">退水設定 - {{ rebateAgent.username }}</h5>
                                    <button type="button" class="btn-close" @click="hideRebateSettingsModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="updateRebateSettings">
                                        <div class="mb-3">
                                            <label class="form-label">退水模式</label>
                                            <select class="form-select" v-model="rebateSettings.rebate_mode" required>
                                                <option value="all">全拿所有退水</option>
                                                <option value="percentage">設定具體比例</option>
                                                <option value="none">全退給下級</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" v-if="rebateSettings.rebate_mode === 'percentage'">
                                            <label class="form-label">退水比例 (%)</label>
                                            <input type="number" class="form-control" v-model="rebateSettings.rebate_percentage" 
                                                   step="0.01" min="0" :max="rebateAgent.max_rebate_percentage * 100" required>
                                            <small class="form-text text-muted">
                                                可設定範圍：0% - {{ (rebateAgent.max_rebate_percentage * 100).toFixed(1) }}%
                                            </small>
                                        </div>
                                        <div class="alert alert-info">
                                            <h6>目前設定：</h6>
                                            <p class="mb-0">
                                                {{ getRebateModeText(rebateAgent.rebate_mode) }}
                                                {{ rebateAgent.rebate_mode === 'percentage' ? ` ${(rebateAgent.rebate_percentage * 100).toFixed(1)}%` : '' }}
                                            </p>
                                        </div>
                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" @click="hideRebateSettingsModal">取消</button>
                                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                                更新
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 編輯代理 Modal -->
                    <div class="modal" id="editAgentModal" tabindex="-1" v-if="showEditAgentModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">編輯代理</h5>
                                    <button type="button" class="btn-close" @click="hideEditAgentModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="updateAgent">
                                        <div class="mb-3">
                                            <label class="form-label">代理ID</label>
                                            <input type="text" class="form-control" v-model="editAgentData.id" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">用戶名</label>
                                            <input type="text" class="form-control" v-model="editAgentData.username" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">修改密碼 (留空表示不修改)</label>
                                            <input type="password" class="form-control" v-model="editAgentData.password">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">狀態</label>
                                            <select class="form-select" v-model="editAgentData.status">
                                                <option value="1">啟用</option>
                                                <option value="0">停用</option>
                                            </select>
                                        </div>
                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" @click="hideEditAgentModal">取消</button>
                                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                                更新
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 會員管理 -->
                <div v-if="activeTab === 'members'">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>會員管理</h2>
                        <button class="btn btn-primary" @click="showMemberModal">
                            <i class="fas fa-plus me-1"></i>新增會員
                        </button>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            搜尋條件
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">狀態</label>
                                    <select class="form-select" v-model="memberFilters.status">
                                        <option value="-1">全部</option>
                                        <option value="1">啟用</option>
                                        <option value="0">停用</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">關鍵字</label>
                                    <input type="text" class="form-control" placeholder="用戶名/ID" v-model="memberFilters.keyword">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-primary" @click="searchMembers">搜尋</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用戶名</th>
                                            <th>餘額</th>
                                            <th>狀態</th>
                                            <th>創建時間</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="members.length === 0">
                                            <td colspan="6" class="text-center">無會員數據</td>
                                        </tr>
                                        <tr v-for="member in members" :key="member.id">
                                            <td>{{ member.id }}</td>
                                            <td>{{ member.username }}</td>
                                            <td>{{ formatMoney(member.balance) }}</td>
                                            <td>
                                                <span class="badge" :class="member.status === 1 ? 'bg-success' : 'bg-danger'">
                                                    {{ member.status === 1 ? '啟用' : '停用' }}
                                                </span>
                                            </td>
                                            <td>{{ formatDate(member.created_at) }}</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-outline-primary" @click="adjustMemberBalance(member)">
                                                        <i class="fas fa-exchange-alt me-1"></i>點數轉移
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning" @click="resetMemberPassword(member)">
                                                        <i class="fas fa-key me-1"></i>重設密碼
                                                    </button>
                                                    <button class="btn btn-sm" :class="member.status === 1 ? 'btn-outline-danger' : 'btn-outline-success'" 
                                                            @click="toggleMemberStatus(member.id, member.status)">
                                                        <i class="fas" :class="member.status === 1 ? 'fa-ban' : 'fa-check'"></i>
                                                        {{ member.status === 1 ? '停用' : '啟用' }}
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" @click="deleteMember(member.id, member.username)">
                                                        <i class="fas fa-trash-alt me-1"></i>刪除
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <nav v-if="memberPagination.totalPages > 1">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" :class="{disabled: memberPagination.currentPage === 1}">
                                        <a class="page-link" href="#" @click.prevent="changePage(memberPagination.currentPage - 1, 'members')">上一頁</a>
                                    </li>
                                    <li class="page-item" v-for="page in memberPagination.totalPages" :key="page" :class="{active: page === memberPagination.currentPage}">
                                        <a class="page-link" href="#" @click.prevent="changePage(page, 'members')">{{ page }}</a>
                                    </li>
                                    <li class="page-item" :class="{disabled: memberPagination.currentPage === memberPagination.totalPages}">
                                        <a class="page-link" href="#" @click.prevent="changePage(memberPagination.currentPage + 1, 'members')">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>



                    <!-- 新增會員 Modal -->
                    <div class="modal" id="createMemberModal" tabindex="-1" v-if="showCreateMemberModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">新增會員</h5>
                                    <button type="button" class="btn-close" @click="hideCreateMemberModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="createMember">
                                        <div class="mb-3">
                                            <label class="form-label">用戶名</label>
                                            <input type="text" class="form-control" v-model="newMember.username" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">密碼</label>
                                            <input type="password" class="form-control" v-model="newMember.password" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">確認密碼</label>
                                            <input type="password" class="form-control" v-model="newMember.confirmPassword" required>
                                        </div>
                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" @click="hideCreateMemberModal">取消</button>
                                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm" role="status"></span>
                                                建立
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 會員餘額調整模態框 -->
                    <div class="modal fade" id="adjustBalanceModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">點數轉移 - {{ balanceAdjustData.memberUsername }}</h5>
                                    <button type="button" class="btn-close" @click="hideAdjustBalanceModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="submitBalanceAdjustment">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">代理餘額</label>
                                                <input type="text" class="form-control" :value="formatMoney(agentCurrentBalance)" disabled>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">會員餘額</label>
                                                <input type="text" class="form-control" :value="formatMoney(balanceAdjustData.currentBalance)" disabled>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">轉移類型</label>
                                            <div class="btn-group w-100">
                                                <input type="radio" class="btn-check" name="transferType" id="deposit" v-model="transferType" value="deposit">
                                                <label class="btn btn-outline-success" for="deposit">存入 (代理→會員)</label>
                                                
                                                <input type="radio" class="btn-check" name="transferType" id="withdraw" v-model="transferType" value="withdraw">
                                                <label class="btn btn-outline-danger" for="withdraw">提領 (會員→代理)</label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">點數轉移金額</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" v-model="transferAmount" 
                                                       placeholder="請輸入要轉移的點數金額" min="0" required>
                                                <span class="input-group-text">元</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">轉移後會員點數</label>
                                            <input type="text" class="form-control" 
                                                   :value="formatMoney(calculateFinalMemberBalance())" 
                                                   disabled>
                                        </div>
                                        
                                                                <div class="mb-3">
                            <label class="form-label">轉移後您的點數</label>
                            <input type="text" class="form-control" 
                                   :value="formatMoney(finalAgentBalance)" 
                                   disabled>
                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">備註說明</label>
                                            <textarea class="form-control" v-model="balanceAdjustData.description" 
                                                      placeholder="請輸入點數轉移原因"></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @click="hideAdjustBalanceModal">取消</button>
                                    <button type="button" class="btn btn-primary" @click="submitBalanceAdjustment" :disabled="!isValidTransfer">
                                        <i class="fas fa-check me-1"></i>確認轉移
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 會員額度修改模態框 -->
                    <div class="modal fade" id="modifyMemberBalanceModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">修改會員額度 - {{ modifyBalanceData.memberUsername }}</h5>
                                    <button type="button" class="btn-close" @click="hideModifyMemberBalanceModal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="submitModifyMemberBalance">
                                        <div class="mb-3">
                                            <label class="form-label">當前額度</label>
                                            <input type="text" class="form-control" :value="formatMoney(modifyBalanceData.currentBalance)" disabled>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">修改方式</label>
                                            <div class="btn-group w-100">
                                                <input type="radio" class="btn-check" name="modifyType" id="modifyAbsolute" v-model="modifyBalanceType" value="absolute">
                                                <label class="btn btn-outline-primary" for="modifyAbsolute">設置絕對值</label>
                                                
                                                <input type="radio" class="btn-check" name="modifyType" id="modifyRelative" v-model="modifyBalanceType" value="relative">
                                                <label class="btn btn-outline-success" for="modifyRelative">增加/減少</label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ modifyBalanceType === 'absolute' ? '新額度' : '變更額度' }}</label>
                                            <div class="input-group">
                                                <span v-if="modifyBalanceType === 'relative'" class="input-group-text">
                                                    <div class="btn-group">
                                                        <input type="radio" class="btn-check" name="changeType" id="increase" v-model="balanceChangeDirection" value="increase">
                                                        <label class="btn btn-sm btn-outline-success" for="increase">+</label>
                                                        
                                                        <input type="radio" class="btn-check" name="changeType" id="decrease" v-model="balanceChangeDirection" value="decrease">
                                                        <label class="btn btn-sm btn-outline-danger" for="decrease">-</label>
                                                    </div>
                                                </span>
                                                <input type="number" step="0.01" class="form-control" v-model="modifyBalanceAmount" 
                                                    placeholder="請輸入金額" min="0" required>
                                                <span class="input-group-text">元</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">修改後額度</label>
                                            <input type="text" class="form-control" :value="formatMoney(calculateFinalModifiedBalance())" disabled>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">操作原因</label>
                                            <textarea class="form-control" v-model="modifyBalanceData.reason" 
                                                placeholder="請輸入修改額度的原因" required></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @click="hideModifyMemberBalanceModal">取消</button>
                                    <button type="button" class="btn btn-primary" @click="submitModifyMemberBalance" :disabled="!isValidBalanceModification">
                                        <i class="fas fa-check me-1"></i>確認修改
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 事務記錄頁面 -->
                <div v-if="activeTab === 'transactions'">
                    <h2>交易記錄</h2>
                    
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link" :class="{active: transactionTab === 'deposit'}" href="#" @click="transactionTab = 'deposit'; loadDepositRecords()">
                                <i class="fas fa-credit-card me-1"></i>存款記錄
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{active: transactionTab === 'withdraw'}" href="#" @click="transactionTab = 'withdraw'; loadWithdrawRecords()">
                                <i class="fas fa-money-bill-wave me-1"></i>提款記錄
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" :class="{active: transactionTab === 'transfers'}" href="#" @click="loadPointTransfers(); transactionTab = 'transfers'">
                                <i class="fas fa-exchange-alt me-1"></i>點數轉移記錄
                            </a>
                        </li>
                    </ul>
                    
                    <!-- 存款記錄 -->
                    <div v-if="transactionTab === 'deposit'" class="card">
                        <div class="card-header">
                            存款記錄
                            <div class="float-end">
                                <button class="btn btn-sm btn-outline-primary" @click="loadDepositRecords()">
                                    <i class="fas fa-sync me-1"></i>刷新
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">編號</th>
                                            <th scope="col">用戶類型</th>
                                            <th scope="col">用戶名稱</th>
                                            <th scope="col">交易類型</th>
                                            <th scope="col">金額</th>
                                            <th scope="col">操作前餘額</th>
                                            <th scope="col">操作後餘額</th>
                                            <th scope="col">說明</th>
                                            <th scope="col">時間</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="record in depositRecords" :key="record.id">
                                            <td>{{ record.id }}</td>
                                            <td>{{ formatUserType(record.user_type) }}</td>
                                            <td>{{ record.username || '未知用戶' }}</td>
                                            <td>
                                                <span class="badge bg-success">{{ formatTransactionType(record) }}</span>
                                            </td>
                                            <td class="text-success">+{{ formatMoney(Math.abs(record.amount)) }}</td>
                                            <td>{{ formatMoney(record.before_balance) }}</td>
                                            <td>{{ formatMoney(record.after_balance) }}</td>
                                            <td>{{ record.description || '-' }}</td>
                                            <td>{{ formatDate(record.created_at) }}</td>
                                        </tr>
                                        <tr v-if="depositRecords.length === 0">
                                            <td colspan="9" class="text-center">無存款記錄</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 提款記錄 -->
                    <div v-if="transactionTab === 'withdraw'" class="card">
                        <div class="card-header">
                            提款記錄
                            <div class="float-end">
                                <button class="btn btn-sm btn-outline-primary" @click="loadWithdrawRecords()">
                                    <i class="fas fa-sync me-1"></i>刷新
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">編號</th>
                                            <th scope="col">用戶類型</th>
                                            <th scope="col">用戶名稱</th>
                                            <th scope="col">交易類型</th>
                                            <th scope="col">金額</th>
                                            <th scope="col">操作前餘額</th>
                                            <th scope="col">操作後餘額</th>
                                            <th scope="col">說明</th>
                                            <th scope="col">時間</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="record in withdrawRecords" :key="record.id">
                                            <td>{{ record.id }}</td>
                                            <td>{{ formatUserType(record.user_type) }}</td>
                                            <td>{{ record.username || '未知用戶' }}</td>
                                            <td>
                                                <span class="badge bg-danger">{{ formatTransactionType(record) }}</span>
                                            </td>
                                            <td class="text-danger">{{ formatMoney(record.amount) }}</td>
                                            <td>{{ formatMoney(record.before_balance) }}</td>
                                            <td>{{ formatMoney(record.after_balance) }}</td>
                                            <td>{{ record.description || '-' }}</td>
                                            <td>{{ formatDate(record.created_at) }}</td>
                                        </tr>
                                        <tr v-if="withdrawRecords.length === 0">
                                            <td colspan="9" class="text-center">無提款記錄</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 點數轉移記錄 -->
                    <div v-if="transactionTab === 'transfers'" class="card">
                        <div class="card-header">
                            點數轉移記錄
                            <div class="float-end">
                                <button class="btn btn-sm btn-outline-primary" @click="loadPointTransfers()">
                                    <i class="fas fa-sync me-1"></i>刷新
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">編號</th>
                                            <th scope="col">類型</th>
                                            <th scope="col">轉移方向</th>
                                            <th scope="col">金額</th>
                                            <th scope="col">轉出前餘額</th>
                                            <th scope="col">轉出後餘額</th>
                                            <th scope="col">轉入前餘額</th>
                                            <th scope="col">轉入後餘額</th>
                                            <th scope="col">說明</th>
                                            <th scope="col">時間</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="transfer in pointTransfers" :key="transfer.id">
                                            <td>{{ transfer.id }}</td>
                                            <td>{{ formatTransferType(transfer) }}</td>
                                            <td>{{ formatTransferDirection(transfer) }}</td>
                                            <td>{{ formatMoney(transfer.amount) }}</td>
                                            <td>{{ formatMoney(transfer.from_before_balance) }}</td>
                                            <td>{{ formatMoney(transfer.from_after_balance) }}</td>
                                            <td>{{ formatMoney(transfer.to_before_balance) }}</td>
                                            <td>{{ formatMoney(transfer.to_after_balance) }}</td>
                                            <td>{{ transfer.description || '-' }}</td>
                                            <td>{{ formatDate(transfer.created_at) }}</td>
                                        </tr>
                                        <tr v-if="pointTransfers.length === 0">
                                            <td colspan="10" class="text-center">無點數轉移記錄</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ... other transaction tabs ... -->
                </div>

                <!-- 開獎記錄 -->
                <div v-if="activeTab === 'draw'">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>開獎記錄</h2>
                        <button class="btn btn-primary" @click="loadDrawHistory">
                            <i class="fas fa-sync-alt me-1"></i>刷新
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text">期數</span>
                                        <input type="text" class="form-control" placeholder="輸入期數查詢" v-model="drawFilters.period">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text">日期</span>
                                        <input type="date" class="form-control" v-model="drawFilters.date">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" @click="searchDrawHistory">
                                        <i class="fas fa-search me-1"></i>搜尋
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-secondary w-100" @click="searchTodayDrawHistory">
                                        <i class="fas fa-calendar-day me-1"></i>今日開獎
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>期數</th>
                                            <th>開獎號碼</th>
                                            <th>開獎時間</th>
                                            <th>冠亞軍</th>
                                            <th>龍虎</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="record in drawRecords" :key="record.period">
                                            <td>{{ record.period }}</td>
                                            <td>
                                                <div class="d-flex">
                                                    <span v-for="(num, index) in record.result || []" :key="index"
                                                          class="number-ball mx-1"
                                                          :class="'color-' + num">
                                                        {{ num || '-' }}
                                                    </span>
                                                </div>
                                            </td>
                                            <td>{{ record.draw_time ? formatDate(record.draw_time) : 'N/A' }}</td>
                                            <td v-if="record && record.result && record.result.length >= 2">
                                                <div>冠: {{ record.result[0] > 5 ? '大' : '小' }} {{ record.result[0] % 2 === 0 ? '雙' : '單' }}</div>
                                                <div>亞: {{ record.result[1] > 5 ? '大' : '小' }} {{ record.result[1] % 2 === 0 ? '雙' : '單' }}</div>
                                            </td>
                                            <td v-else><span>-</span></td>
                                            <td>
                                                <span v-if="record && record.result && record.result.length >= 10" 
                                                      :class="{'text-danger': record.result[0] > record.result[9], 'text-primary': record.result[0] < record.result[9]}">
                                                    {{ getDragonTigerResult(record).value }}
                                                </span>
                                                <span v-else>-</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <!-- 無記錄顯示 -->
                                <div v-if="drawRecords.length === 0" class="text-center py-4">
                                    <p class="text-muted">暫無開獎記錄</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 分頁控制 -->
                        <div class="card-footer">
                            <nav v-if="drawPagination.totalPages > 1">
                                <ul class="pagination justify-content-center mb-0">
                                    <li class="page-item" :class="{disabled: drawPagination.currentPage === 1}">
                                        <a class="page-link" href="#" @click.prevent="changePage(1, 'draw')">首頁</a>
                                    </li>
                                    <li class="page-item" :class="{disabled: drawPagination.currentPage === 1}">
                                        <a class="page-link" href="#" @click.prevent="changePage(drawPagination.currentPage - 1, 'draw')">上一頁</a>
                                    </li>
                                    
                                    <li v-for="page in getPageRange(drawPagination.currentPage, drawPagination.totalPages)" 
                                        :key="page" 
                                        class="page-item" 
                                        :class="{active: page === drawPagination.currentPage}">
                                        <a class="page-link" href="#" @click.prevent="changePage(page, 'draw')">{{ page }}</a>
                                    </li>
                                    
                                    <li class="page-item" :class="{disabled: drawPagination.currentPage === drawPagination.totalPages}">
                                        <a class="page-link" href="#" @click.prevent="changePage(drawPagination.currentPage + 1, 'draw')">下一頁</a>
                                    </li>
                                    <li class="page-item" :class="{disabled: drawPagination.currentPage === drawPagination.totalPages}">
                                        <a class="page-link" href="#" @click.prevent="changePage(drawPagination.totalPages, 'draw')">末頁</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- 統計數據 -->
                <div v-if="activeTab === 'stats'">
                    <h2>下注記錄</h2>
                    <div class="card mb-4">
                        <div class="card-header">
                            搜尋條件
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">會員</label>
                                    <select class="form-select" v-model="betFilters.member">
                                        <option value="">全部會員</option>
                                        <option v-for="member in members" :key="member.id" :value="member.username">
                                            {{ member.username }}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">日期</label>
                                    <input type="date" class="form-control" v-model="betFilters.date">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">期數</label>
                                    <input type="text" class="form-control" placeholder="輸入期數" v-model="betFilters.period">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" @click="searchBets">
                                        <i class="fas fa-search me-1"></i>搜尋
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>會員</th>
                                            <th>期數</th>
                                            <th>投注類型</th>
                                            <th>位置</th>
                                            <th>投注選項</th>
                                            <th>金額</th>
                                            <th>賠率</th>
                                            <th>輸贏</th>
                                            <th>盈虧</th>
                                            <th>時間</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="bets.length === 0">
                                            <td colspan="10" class="text-center">暫無下注記錄</td>
                                        </tr>
                                        <tr v-for="bet in bets" :key="bet.id">
                                            <td>{{ bet.username }}</td>
                                            <td>{{ bet.period }}</td>
                                            <td>{{ formatBetType(bet.bet_type) }}</td>
                                            <td>{{ formatPosition(bet.position, bet.bet_type) }}</td>
                                            <td>{{ formatBetValue(bet.bet_value) }}</td>
                                            <td>{{ formatMoney(bet.amount) }}</td>
                                            <td>{{ bet.odds }}</td>
                                            <td>
                                                <span v-if="bet.settled" :class="bet.win ? 'text-success' : 'text-danger'">
                                                    {{ bet.win ? '贏' : '輸' }}
                                                </span>
                                                <span v-else class="text-warning">未結算</span>
                                            </td>
                                            <td :class="bet.win ? 'text-success' : 'text-danger'">
                                                {{ formatMoney(bet.win ? bet.win_amount - bet.amount : -bet.amount) }}
                                            </td>
                                            <td>{{ formatDate(bet.created_at) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <nav v-if="betPagination.totalPages > 1">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" :class="{disabled: betPagination.currentPage === 1}">
                                        <a class="page-link" href="#" @click.prevent="changePage(betPagination.currentPage - 1, 'bets')">上一頁</a>
                                    </li>
                                    <li class="page-item" v-for="page in getPageRange(betPagination.currentPage, betPagination.totalPages)" :key="page" :class="{active: page === betPagination.currentPage}">
                                        <a class="page-link" href="#" @click.prevent="changePage(page, 'bets')">{{ page }}</a>
                                    </li>
                                    <li class="page-item" :class="{disabled: betPagination.currentPage === betPagination.totalPages}">
                                        <a class="page-link" href="#" @click.prevent="changePage(betPagination.currentPage + 1, 'bets')">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            下注統計信息
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body">
                                            <h5 class="card-title">總投注筆數</h5>
                                            <h2 class="card-text">{{ betStats.totalBets || 0 }}</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h5 class="card-title">總投注金額</h5>
                                            <h2 class="card-text">{{ formatMoney(betStats.totalAmount || 0) }}</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card" :class="betStats.totalProfit >= 0 ? 'bg-success' : 'bg-danger'">
                                        <div class="card-body text-white">
                                            <h5 class="card-title">會員總盈虧</h5>
                                            <h2 class="card-text">{{ formatMoney(betStats.totalProfit || 0) }}</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card" :class="betStats.totalProfit < 0 ? 'bg-success' : 'bg-danger'">
                                        <div class="card-body text-white">
                                            <h5 class="card-title">代理收益</h5>
                                            <h2 class="card-text">{{ formatMoney(betStats.totalProfit ? -betStats.totalProfit : 0) }}</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系統公告 -->
                <div v-if="activeTab === 'notices'">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>系統公告</h2>
                        <button v-if="user.level === 0" class="btn btn-success" @click="showNoticeForm = !showNoticeForm">
                            <i class="fas fa-plus me-1"></i>{{ showNoticeForm ? '取消新增' : '新增公告' }}
                        </button>
                    </div>
                    
                    <!-- 新增/編輯公告表單 -->
                    <div v-if="showNoticeForm && user.level === 0" class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bullhorn me-2"></i>{{ editingNoticeId ? '編輯公告' : '新增公告' }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="submitNotice">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label class="form-label">公告標題 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" v-model="noticeForm.title" 
                                                   placeholder="請輸入公告標題" maxlength="100" required>
                                            <div class="form-text">標題長度：{{ (noticeForm.title || '').length }}/100</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">公告分類</label>
                                            <select class="form-select" v-model="noticeForm.category">
                                                <option value="最新公告">最新公告</option>
                                                <option value="維修">維修</option>
                                                <option value="活動">活動</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">公告內容 <span class="text-danger">*</span></label>
                                    <textarea class="form-control" v-model="noticeForm.content" 
                                              placeholder="請輸入公告內容" rows="5" required></textarea>
                                    <div class="form-text">內容長度：{{ (noticeForm.content || '').length }} 字符</div>
                                </div>
                                
                                <!-- 預覽區域 -->
                                <div class="mb-3">
                                    <label class="form-label">公告預覽</label>
                                    <div class="border rounded p-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge me-2" 
                                                  :class="{
                                                      'bg-info': noticeForm.category === '最新公告',
                                                      'bg-warning': noticeForm.category === '維修',
                                                      'bg-success': noticeForm.category === '活動'
                                                  }">
                                                {{ noticeForm.category }}
                                            </span>
                                            <h6 class="mb-0">{{ noticeForm.title || '公告標題' }}</h6>
                                        </div>
                                        <p class="mb-0 text-muted">{{ noticeForm.content || '公告內容' }}</p>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>{{ getCurrentDateTime() }}
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <button type="button" class="btn btn-secondary me-2" @click="cancelNoticeEdit">取消</button>
                                    <button type="submit" class="btn btn-primary" :disabled="loading">
                                        <span v-if="loading" class="spinner-border spinner-border-sm me-1" role="status"></span>
                                        <i class="fas fa-save me-1" v-if="!loading"></i>
                                        {{ editingNoticeId ? '更新公告' : '發布公告' }}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 分類篩選 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            公告分類
                        </div>
                        <div class="card-body">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="noticeCategory" id="categoryAll" v-model="selectedNoticeCategory" value="all" @change="filterNoticesByCategory('all')">
                                <label class="btn btn-outline-primary" for="categoryAll">全部</label>
                                
                                <input type="radio" class="btn-check" name="noticeCategory" id="categoryNews" v-model="selectedNoticeCategory" value="最新公告" @change="filterNoticesByCategory('最新公告')">
                                <label class="btn btn-outline-info" for="categoryNews">最新公告</label>
                                
                                <input type="radio" class="btn-check" name="noticeCategory" id="categoryMaintenance" v-model="selectedNoticeCategory" value="維修" @change="filterNoticesByCategory('維修')">
                                <label class="btn btn-outline-warning" for="categoryMaintenance">維修</label>
                                
                                <input type="radio" class="btn-check" name="noticeCategory" id="categoryActivity" v-model="selectedNoticeCategory" value="活動" @change="filterNoticesByCategory('活動')">
                                <label class="btn btn-outline-success" for="categoryActivity">活動</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 公告列表 -->
                    <div class="card">
                        <div class="card-body">
                            <div v-if="notices.length === 0" class="text-center py-5">
                                <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                                <p class="text-muted">暫無公告</p>
                            </div>
                            
                            <div v-else>
                                <div v-for="notice in notices" :key="notice.id" class="notice-item mb-4 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge me-2" 
                                                      :class="{
                                                          'bg-info': notice.category === '最新公告',
                                                          'bg-warning': notice.category === '維修',
                                                          'bg-success': notice.category === '活動'
                                                      }">
                                                    {{ notice.category }}
                                                </span>
                                                <h5 class="mb-0">{{ notice.title }}</h5>
                                            </div>
                                            <p class="text-muted mb-0">{{ notice.content }}</p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="mb-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>
                                                    {{ formatDate(notice.created_at) }}
                                                </small>
                                            </div>
                                            <div v-if="user.level === 0" class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" @click="startEditNotice(notice)">
                                                    <i class="fas fa-edit me-1"></i>編輯
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" @click="deleteNotice(notice)">
                                                    <i class="fas fa-trash me-1"></i>刪除
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 客服功能 -->
                <div v-if="activeTab === 'customer-service' && user.level === 0">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>客服功能</h2>
                        <div class="btn-group">
                            <button class="btn btn-primary" @click="showCSOperationModalFunc">
                                <i class="fas fa-exchange-alt me-1"></i>新增轉帳
                            </button>
                        </div>
                    </div>
                    
                    <!-- 功能說明卡片 -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-user-shield fa-2x"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">客服權限</h5>
                                            <p class="card-text mb-0">可以調整任何代理或會員的餘額</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-history fa-2x"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">完整記錄</h5>
                                            <p class="card-text mb-0">所有操作都會記錄在系統中</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-bullhorn fa-2x"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">公告管理</h5>
                                            <p class="card-text mb-0">可以新增和管理系統公告</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作記錄 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">客服操作記錄</h5>
                                <div class="d-flex gap-2">
                                    <!-- 篩選選項 -->
                                    <select class="form-select form-select-sm" v-model="csTransactionFilters.userType" @change="loadCSTransactions(1)">
                                        <option value="all">全部用戶</option>
                                        <option value="agent">代理</option>
                                        <option value="member">會員</option>
                                    </select>
                                    <select class="form-select form-select-sm" v-model="csTransactionFilters.transactionType" @change="loadCSTransactions(1)">
                                        <option value="all">全部操作</option>
                                        <option value="cs_deposit">客服存款</option>
                                        <option value="cs_withdraw">客服提款</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" @click="loadCSTransactions(1)">
                                        <i class="fas fa-sync me-1"></i>刷新
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>編號</th>
                                            <th>用戶類型</th>
                                            <th>用戶名</th>
                                            <th>操作類型</th>
                                            <th>變化金額</th>
                                            <th>操作前餘額</th>
                                            <th>操作後餘額</th>
                                            <th>說明</th>
                                            <th>操作時間</th>
                                        </tr>
                                    </thead>
                                    <tbody v-if="csTransactions.length > 0">
                                        <tr v-for="transaction in csTransactions" :key="transaction.id">
                                            <td>{{ transaction.id }}</td>
                                            <td>
                                                <span class="badge" :class="transaction.user_type === 'agent' ? 'bg-primary' : 'bg-info'">
                                                    {{ transaction.user_type === 'agent' ? '代理' : '會員' }}
                                                </span>
                                            </td>
                                            <td>{{ transaction.username }}</td>
                                            <td>
                                                <span class="badge" :class="transaction.type === 'cs_deposit' ? 'bg-success' : 'bg-danger'">
                                                    {{ transaction.type === 'cs_deposit' ? '客服存款' : '客服提款' }}
                                                </span>
                                            </td>
                                            <td>
                                                <span :class="transaction.amount >= 0 ? 'text-success' : 'text-danger'">
                                                    {{ transaction.amount >= 0 ? '+' : '' }}{{ formatMoney(transaction.amount) }}
                                                </span>
                                            </td>
                                            <td>{{ formatMoney(transaction.before_balance) }}</td>
                                            <td>{{ formatMoney(transaction.after_balance) }}</td>
                                            <td>{{ transaction.description || '-' }}</td>
                                            <td>{{ formatDateTime(transaction.created_at) }}</td>
                                        </tr>
                                    </tbody>
                                    <tbody v-else>
                                        <tr>
                                            <td colspan="9" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                                <div>暫無客服操作記錄</div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 分頁 -->
                            <nav v-if="csTransactionsPagination.total > csTransactionsPagination.limit">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" :class="{disabled: csTransactionsPagination.page <= 1}">
                                        <a class="page-link" href="#" @click.prevent="loadCSTransactionsPrevPage">上一頁</a>
                                    </li>
                                    <li class="page-item active">
                                        <span class="page-link">{{ csTransactionsPagination.page }} / {{ Math.ceil(csTransactionsPagination.total / csTransactionsPagination.limit) }}</span>
                                    </li>
                                    <li class="page-item" :class="{disabled: csTransactionsPagination.page >= Math.ceil(csTransactionsPagination.total / csTransactionsPagination.limit)}">
                                        <a class="page-link" href="#" @click.prevent="loadCSTransactionsNextPage">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 代理額度修改模態框 -->
        <div class="modal fade" id="adjustAgentBalanceModal" tabindex="-1" aria-labelledby="adjustAgentBalanceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adjustAgentBalanceModalLabel">點數轉移</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="submitAgentBalanceAdjustment">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">您的餘額</label>
                                <input type="text" class="form-control" :value="formatMoney(user.balance)" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">下級代理餘額</label>
                                <input type="text" class="form-control" :value="formatMoney(agentBalanceData.currentBalance)" disabled>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">轉移類型</label>
                            <div class="btn-group w-100">
                                <input type="radio" class="btn-check" name="agentTransferType" id="agentDeposit" v-model="agentTransferType" value="deposit">
                                <label class="btn btn-outline-success" for="agentDeposit">存入 (您→下級代理)</label>
                                
                                <input type="radio" class="btn-check" name="agentTransferType" id="agentWithdraw" v-model="agentTransferType" value="withdraw">
                                <label class="btn btn-outline-danger" for="agentWithdraw">提領 (下級代理→您)</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">點數轉移金額</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" v-model="agentTransferAmount" 
                                       placeholder="請輸入要轉移的點數金額" min="0" required>
                                <span class="input-group-text">元</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">轉移後下級代理點數</label>
                            <input type="text" class="form-control" 
                                   :value="formatMoney(calculateFinalSubAgentBalance())" 
                                   disabled>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">轉移後您的點數</label>
                            <input type="text" class="form-control" 
                                   :value="formatMoney(calculateFinalParentAgentBalance())" 
                                   disabled>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">備註說明</label>
                            <textarea class="form-control" v-model="agentBalanceData.description" 
                                      placeholder="請輸入點數轉移原因"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="submitAgentBalanceAdjustment" :disabled="!isValidAgentTransfer">
                        <i class="fas fa-check me-1"></i>確認轉移
                    </button>
                </div>
            </div>
        </div>
        </div>

        <!-- 重設密碼 Modal -->
        <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="resetPasswordModalLabel">重設密碼</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="submitPasswordReset">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                為了安全起見，舊密碼不會顯示。請直接輸入新密碼。
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">用戶類型</label>
                                <input type="text" class="form-control" :value="resetPasswordData.userType === 'agent' ? '代理' : '會員'" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">用戶名</label>
                                <input type="text" class="form-control" :value="resetPasswordData.username" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">新密碼 <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" v-model="resetPasswordData.newPassword" required 
                                       placeholder="請輸入新密碼" minlength="6">
                                <small class="form-text text-muted">密碼長度至少6個字符</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">確認新密碼 <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" v-model="resetPasswordData.confirmPassword" required 
                                       placeholder="請再次輸入新密碼">
                            </div>
                            
                            <div class="mb-3" v-if="resetPasswordData.newPassword && resetPasswordData.confirmPassword">
                                <div v-if="resetPasswordData.newPassword === resetPasswordData.confirmPassword" class="text-success">
                                    <i class="fas fa-check me-1"></i>密碼匹配
                                </div>
                                <div v-else class="text-danger">
                                    <i class="fas fa-times me-1"></i>兩次輸入的密碼不一致
                                </div>
                            </div>
                            
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-warning" :disabled="!isPasswordResetValid || loading">
                                    <span v-if="loading" class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    <i class="fas fa-key me-1" v-if="!loading"></i>
                                    重設密碼
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 個人資料 Modal -->
        <div v-if="isProfileModalVisible" class="modal d-block" id="profileModal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user me-2"></i>個人資料
                        </h5>
                        <button type="button" class="btn-close" @click="hideProfileModal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateProfile">
                            <div class="row">
                                <!-- 基本信息 -->
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-id-card me-1"></i>基本信息
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">用戶名</label>
                                        <input type="text" class="form-control" :value="user.username" readonly>
                                        <small class="form-text text-muted">用戶名無法修改</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">代理級別</label>
                                        <input type="text" class="form-control" :value="getLevelName(user.level)" readonly>
                                        <small class="form-text text-muted">代理級別無法修改</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">真實姓名</label>
                                        <input type="text" class="form-control" v-model="profileData.realName" 
                                               placeholder="請輸入真實姓名">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">聯絡電話</label>
                                        <input type="tel" class="form-control" v-model="profileData.phone" 
                                               placeholder="請輸入聯絡電話">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">電子郵件</label>
                                        <input type="email" class="form-control" v-model="profileData.email" 
                                               placeholder="請輸入電子郵件">
                                    </div>
                                </div>
                                
                                <!-- 詳細信息 -->
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-info-circle me-1"></i>詳細信息
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Line ID</label>
                                        <input type="text" class="form-control" v-model="profileData.lineId" 
                                               placeholder="請輸入Line ID">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Telegram</label>
                                        <input type="text" class="form-control" v-model="profileData.telegram" 
                                               placeholder="請輸入Telegram">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">地址</label>
                                        <textarea class="form-control" rows="3" v-model="profileData.address" 
                                                  placeholder="請輸入地址"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">備註</label>
                                        <textarea class="form-control" rows="3" v-model="profileData.remark" 
                                                  placeholder="其他備註信息"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" @click="hideProfileModal">取消</button>
                                <button type="submit" class="btn btn-primary" :disabled="profileLoading">
                                    <span v-if="profileLoading" class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    <i class="fas fa-save me-1" v-if="!profileLoading"></i>
                                    儲存資料
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- 客服存款/提款操作 Modal -->
    <div class="modal fade" id="csOperationModal" tabindex="-1" aria-labelledby="csOperationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="csOperationModalLabel">客服存款/提款操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="csOperationForm">
                        <!-- 操作對象 -->
                        <div class="mb-3">
                            <label class="form-label">操作對象</label>
                            <div class="btn-group w-100">
                                <input type="radio" class="btn-check" name="csOperationTarget" id="csTargetAgent" value="agent">
                                <label class="btn btn-outline-primary" for="csTargetAgent">代理</label>
                                
                                <input type="radio" class="btn-check" name="csOperationTarget" id="csTargetMember" value="member">
                                <label class="btn btn-outline-info" for="csTargetMember">會員</label>
                            </div>
                        </div>
                        
                        <!-- 選擇代理 -->
                        <div class="mb-3" id="agentSelectDiv" style="display: none;">
                            <label class="form-label">選擇代理</label>
                            <select id="agentSelect" class="form-select" required>
                                <option value="">請選擇代理</option>
                            </select>
                        </div>
                        
                        <!-- 選擇會員 -->
                        <div class="mb-3" id="memberSelectDiv" style="display: none;">
                            <label class="form-label">選擇會員</label>
                            <select id="memberSelect" class="form-select" required>
                                <option value="">請選擇會員</option>
                            </select>
                        </div>
                        
                        <!-- 當前餘額顯示 -->
                        <div class="row mb-3" id="currentBalanceDiv" style="display: none;">
                            <div class="col-md-12">
                                <label class="form-label">當前餘額</label>
                                <input id="currentBalanceInput" type="text" class="form-control" disabled>
                            </div>
                        </div>
                        
                        <!-- 操作類型 -->
                        <div class="mb-3" id="operationTypeDiv" style="display: none;">
                            <label class="form-label">操作類型</label>
                            <div class="btn-group w-100">
                                <input type="radio" class="btn-check" name="csTransferType" id="csDeposit" value="deposit">
                                <label class="btn btn-outline-success" for="csDeposit">存款</label>
                                
                                <input type="radio" class="btn-check" name="csTransferType" id="csWithdraw" value="withdraw">
                                <label class="btn btn-outline-danger" for="csWithdraw">提款</label>
                            </div>
                        </div>
                        
                        <!-- 操作金額 -->
                        <div class="mb-3" id="amountDiv" style="display: none;">
                            <label class="form-label">操作金額</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" id="amountInput"
                                       placeholder="請輸入操作金額" min="0" required>
                                <span class="input-group-text">元</span>
                            </div>
                        </div>
                        
                        <!-- 操作後餘額預覽 -->
                        <div class="mb-3" id="finalBalanceDiv" style="display: none;">
                            <label class="form-label">操作後餘額</label>
                            <input id="finalBalanceInput" type="text" class="form-control" disabled>
                        </div>
                        
                        <!-- 操作說明 -->
                        <div class="mb-3">
                            <label class="form-label">操作說明</label>
                            <textarea class="form-control" id="csOperationDescription"
                                      placeholder="請輸入操作說明（可選）" rows="3"></textarea>
                        </div>
                        
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" id="csOperationSubmitBtn">
                                <span id="csOperationSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                                確認操作
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // 延遲載入主腳本，確保 Vue 已完全載入
        window.addEventListener('load', function() {
            console.log('頁面完全載入，Vue可用性:', typeof Vue);
            if (typeof Vue !== 'undefined') {
                const script = document.createElement('script');
                                 script.src = 'js/main.js';
                script.onload = function() {
                    console.log('main.js 載入完成');
                };
                script.onerror = function() {
                    console.error('main.js 載入失敗');
                };
                document.body.appendChild(script);
            } else {
                console.error('Vue 未正確載入');
                alert('系統載入失敗，請重新整理頁面');
            }
        });
    </script>
    <script>
        async function updateProfile() {
            console.log('開始更新個人資料...');
            this.profileLoading = true;
            try {
                console.log('準備送出 axios 請求');
                const response = await axios.post(/* ... */);
                console.log('收到API回應:', response.data);
                if (response.data.success) {
                    console.log('API成功，準備關閉modal');
                } else {
                    console.log('API失敗:', response.data.message);
                }
            } catch (error) {
                console.error('catch error:', error);
            } finally {
                console.log('finally: profileLoading 設為 false');
                this.profileLoading = false;
            }
        }
    </script>
</body>
</html>