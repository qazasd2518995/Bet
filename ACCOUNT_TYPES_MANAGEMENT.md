# 三种帐号类型管理说明

## 帐号类型概述

系统中有三种不同的帐号类型，各自有不同的用途和权限：

### 1. 代理帐号 (agents)
- **用途**：管理会员、处理资金、查看报表
- **储存表**：`agents`
- **登入入口**：代理管理系统 (port 3003)
- **特征**：
  - 有层级关系（总代理 level 0 到 15级代理）
  - 可以创建下级代理和会员
  - 有退水比例设置
  - 可以进行资金操作

### 2. 会员帐号 (members)
- **用途**：进行投注、查看个人记录
- **储存表**：`members`
- **登入入口**：游戏前台 (port 3000)
- **特征**：
  - 属于某个代理管理
  - 只能进行投注操作
  - 无法创建其他帐号
  - 资金由代理管理

### 3. 子帐号 (sub_accounts)
- **用途**：代理的辅助帐号，只能查看报表
- **储存表**：`sub_accounts`
- **登入入口**：代理管理系统 (port 3003)
- **特征**：
  - 属于某个代理（每个代理最多2个子帐号）
  - 只能查看报表查询功能
  - 无法进行任何修改操作
  - 登入后 level 设为 99 作为识别

## 用户名唯一性规则

### 修改前的问题
- 各表独立检查，导致可能存在相同用户名
- 例如：`justin2025A` 同时存在于代理表和子帐号表
- 可能造成登入混乱和权限问题

### 修改后的规则
所有用户名必须在三个表中都保持唯一：

1. **创建代理时**：检查 agents + members + sub_accounts
2. **创建会员时**：检查 members + agents + sub_accounts  
3. **创建子帐号时**：检查 sub_accounts + agents + members

### 错误提示
- 被代理使用：「该用户名已被使用（代理）」
- 被会员使用：「该用户名已被使用（会员）」
- 被子帐号使用：「该用户名已被使用（子帐号）」

## 登入流程

### 代理系统登入 (`/api/agent/login`)
1. 先查询 agents 表
2. 如果不是代理，查询 sub_accounts 表
3. 根据帐号类型设置不同的权限标记

### 会员系统登入 (`/api/member/login`)
1. 只查询 members 表
2. 通过代理系统 API 验证

## 权限区别

| 功能 | 代理 | 会员 | 子帐号 |
|------|------|------|--------|
| 创建代理 | ✓ (根据层级) | ✗ | ✗ |
| 创建会员 | ✓ | ✗ | ✗ |
| 创建子帐号 | ✓ | ✗ | ✗ |
| 资金操作 | ✓ | ✗ | ✗ |
| 查看报表 | ✓ | ✗ | ✓ |
| 系统公告 | ✓ | ✗ | ✗ |
| 投注功能 | ✗ | ✓ | ✗ |

## 资料库约束

- `agents.username`: UNIQUE 约束
- `members.username`: UNIQUE 约束
- `sub_accounts.username`: 应该添加 UNIQUE 约束

## 建议的清理操作

对于现有的重复用户名（如 justin2025A），建议：
1. 保留代理帐号
2. 删除或重命名子帐号
3. 确保未来不会再出现重复

## 安全考量

1. **避免用户混淆**：统一的用户名空间避免用户输错系统
2. **权限隔离**：不同类型帐号有明确的权限边界
3. **审计追踪**：所有操作都可以追溯到唯一的用户